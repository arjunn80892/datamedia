<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Sales Quotation</title>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --highlight: #00adb5; --bg: #f5f7fa; --white: #fff; --text: #222831;
            --danger: #dc3545; --success: #28a745; --warning: #ffc107;
        }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); margin: 0; padding: 20px; visibility: hidden; }
        .container { max-width: 1100px; margin: auto; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05); }
        h2 { text-align: center; margin-bottom: 25px; color: var(--text); }
        label { font-weight: 500; margin-top: 15px; display: block; color: #555; }
        input, select, textarea {
            width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border: 1px solid #ccc;
            border-radius: 8px; font-size: 15px; box-sizing: border-box; transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--highlight); outline: none; }
        .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .product-section { margin-top: 20px; padding: 20px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .product-input-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .product-input-row select, .product-input-row input, .product-input-row textarea { flex: 1; min-width: 120px; }
        .add-product {
            margin-top: 10px; background: var(--highlight); color: white; padding: 8px 16px; border: none;
            border-radius: 8px; cursor: pointer; transition: background-color 0.2s;
        }
        .add-product:hover { background-color: #008a91; }
        .totals-wrapper { display: flex; justify-content: flex-end; margin-top: 25px; }
        .totals { background: #eef6f6; padding: 20px; border-radius: 10px; width: 100%; max-width: 450px; }
        .totals p { margin: 10px 0; font-weight: 500; display: flex; align-items: center; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        table th, table td { border: 1px solid #ccc; padding: 12px 10px; text-align: left; font-size: 14px; vertical-align: top; }
        table th { background-color: var(--highlight); color: white; }
        .product-description-row td { background: #f9f9f9; font-style: italic; padding-left: 15px; font-size: 13px; border-top: none; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; color: white; margin-right: 5px; }
        .edit-btn { background-color: var(--warning); color: black; }
        .remove-btn { background-color: var(--danger); }
        .actions { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        .actions button { flex: 1; padding: 12px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; min-width: 160px; font-weight: 500;}
        .submit { background: var(--highlight); color: white; }
        .save { background: var(--success); color: white; }
        .cancel { background: var(--danger); color: white; }
        .back { background: #9e9e9e; color: white; }
        .search-container { position: relative; }
        .search-results-container {
            display: none; position: absolute; top: 100%; left: 0; right: 0; background: white;
            border: 1px solid #ccc; max-height: 250px; overflow-y: auto; z-index: 100;
            border-radius: 0 0 8px 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .search-result-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result-item:hover { background-color: #f0f8ff; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item strong { color: var(--highlight); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .modal-buttons button { padding: 8px 20px; border-radius: 6px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Create Sales Quotation</h2>
        <form id="quotationForm">
            <input type="hidden" id="quotationId" value="">
            <div class="search-container" style="margin-bottom: 20px;">
                <label for="clientSearchInput">Search for Existing Client (Optional)</label>
                <input type="text" id="clientSearchInput" placeholder="Start typing to find a client and auto-fill details..." autocomplete="off">
                <div id="clientSearchResultsContainer" class="search-results-container"></div>
            </div>
            <div class="grid-row">
                <div><label>Company Name</label><select id="companySelect"><option value="Datamedia">Datamedia</option></select></div>
                <div><label>Client Name</label><input type="text" id="clientName" placeholder="Enter client name or use search" required /></div>
                <div><label>Branch Name</label><input type="text" id="branchName" placeholder="Enter branch name (optional)" /></div>
            </div>
            <div class="grid-row">
                <div><label>Customer Name (if different)</label><input type="text" id="customerName" placeholder="Optional" /></div>
                <div><label for="referenceNumber">Reference Number</label><input type="text" id="referenceNumber" placeholder="Optional" /></div>
                <div><label>Billing Address</label><textarea rows="3" placeholder="Select a client to auto-fill" id="billingAddress" required></textarea></div>
            </div>
            <div class="grid-row">
                <div><label>Quotation Date</label><input type="date" id="quotationDate" required/></div>
                <div><label>Tax Rule</label><select id="taxRule" onchange="updateTotals()"><option value="cgst_sgst">CGST + SGST (9% + 9%)</option><option value="igst">IGST (18%)</option></select></div>
            </div>
        </form>
        <div class="product-section">
            <div class="search-container">
                <label for="productSearchInput">Search & Add Product</label>
                <input type="text" id="productSearchInput" placeholder="Start typing product name or code..." autocomplete="off">
                <div id="productSearchResultsContainer" class="search-results-container"></div>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
            <label>Product Details (for adding to quote)</label>
            <div class="product-input-row" id="productInputRow">
                <input type="text" placeholder="Product Name" id="productName" />
                <input type="text" placeholder="Brand" id="brand" />
                <select id="unit"><option value="Nos">Nos</option><option value="Meter">Meter</option><option value="kg">kg</option></select>
                <input type="number" placeholder="Quantity" min="1" id="quantity" value="1"/>
                <input type="number" placeholder="Price" id="price" step="0.01"/>
                <input type="number" placeholder="Discount %" id="discount" min="0" max="100" value="0"/>
                <textarea placeholder="Product Description" id="productDescription" rows="1"></textarea>
            </div>
            <button class="add-product" id="addProductBtn">‚ûï Add Product</button>
        </div>
        <table id="savedProductsTable" style="display:none;">
            <thead><tr><th>Product / Description</th><th>Brand</th><th>Unit</th><th>Qty</th><th>Price (‚Çπ)</th><th>Disc (%)</th><th>Total (‚Çπ)</th><th>Actions</th></tr></thead>
            <tbody id="savedProductsBody"></tbody>
        </table>
        <div class="totals-wrapper">
            <div class="totals">
                <p>Subtotal: <span>‚Çπ<span id="subtotal">0.00</span></span></p>
                <p id="cgstRow" style="display: none;">CGST (9%): <span>‚Çπ<span id="cgst">0.00</span></span></p>
                <p id="sgstRow" style="display: none;">SGST (9%): <span>‚Çπ<span id="sgst">0.00</span></span></p>
                <p id="igstRow" style="display: none;">IGST (18%): <span>‚Çπ<span id="igst">0.00</span></span></p>
                <p id="totalTaxRow" style="display: none;">Total Tax: <span>‚Çπ<span id="totalTax">0.00</span></span></p>
                <p><strong>Grand Total:</strong> <strong><span>‚Çπ<span id="grandTotal">0.00</span></span></strong></p>
            </div>
        </div>
        <div class="actions">
            <button class="back">‚Üê Go Back</button>
            <button class="cancel">‚ûï New Quotation</button>
            <button class="save" id="saveQuotationBtn">üíæ Save / Update Quotation</button>
            <button class="submit" id="generatePdfBtn">‚úî Generate Quotation PDF</button>
        </div>
    </div>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalText">Are you sure?</p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" style="background-color: var(--danger); color: white;">Confirm</button>
                <button id="modalCancelBtn" style="background-color: #6c757d; color: white;">Cancel</button>
            </div>
        </div>
    </div>
<script>
    // --- SUPABASE CONFIGURATION ---
    const SUPABASE_URL = 'https://riisjtqzsjebzjanwvgt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpaXNqdHF6c2plYnpqYW53dmd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NTA4MTYsImV4cCI6MjA2NzAyNjgxNn0.x-Z3OMFnpM_FZkCU4WwzDpYC-Hu7IqppEMeJYppxoxY';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- GLOBAL STATE ---
    let savedProducts = [];
    let lastSavedQuotationData = null;
    let selectedProductForAdding = null;
    let selectedClientForQuotation = null; 
    let currentlyEditingIndex = null;
    let confirmCallback = null;

    // --- DOM ELEMENT REFERENCES ---
    const quotationForm = document.getElementById('quotationForm');
    const quotationIdInput = document.getElementById('quotationId');
    const clientSearchInput = document.getElementById('clientSearchInput');
    const clientSearchResultsContainer = document.getElementById('clientSearchResultsContainer');
    const clientNameInput = document.getElementById('clientName');
    const billingAddressInput = document.getElementById('billingAddress');
    const productSearchInput = document.getElementById('productSearchInput');
    const productSearchResultsContainer = document.getElementById('productSearchResultsContainer');
    const addProductBtn = document.getElementById('addProductBtn');
    const savedProductsTable = document.getElementById('savedProductsTable');
    const savedProductsBody = document.getElementById('savedProductsBody');
    const saveQuotationBtn = document.getElementById('saveQuotationBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const productNameInput = document.getElementById("productName");
    const brandInput = document.getElementById("brand");
    const unitSelect = document.getElementById("unit");
    const descriptionInput = document.getElementById("productDescription");
    const quantityInput = document.getElementById("quantity");
    const priceInput = document.getElementById("price");
    const discountInput = document.getElementById("discount");
    const confirmModal = document.getElementById('confirmModal');
    const modalText = document.getElementById('modalText');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    // --- AUTHENTICATION & INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async function() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        window.location.href = 'index.html';
      } else {
        document.body.style.visibility = 'visible';
        initializePage();
      }
    });

    function initializePage() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('quotationDate').value = today;
        updateTotals();
        setupEventListeners();
    }

    // --- DEBOUNCE UTILITY ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // --- SEARCH & DATA FETCHING ---
    const debouncedClientSearch = debounce(async (query) => {
        const resultsContainer = document.getElementById('clientSearchResultsContainer');
        if (query.length < 1) {
            resultsContainer.style.display = 'none';
            return;
        }
        const { data, error } = await supabaseClient
            .from('customers')
            .select('id, name, address, phone, gstin')
            .ilike('name', `%${query}%`);

        resultsContainer.innerHTML = '';
        if (error || !data.length) {
            resultsContainer.style.display = 'none';
            return;
        }
        
        data.forEach(client => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.textContent = `${client.name} (${client.phone || 'No Phone'})`;
            item.onclick = () => selectClient(client);
            resultsContainer.appendChild(item);
        });
        resultsContainer.style.display = 'block';
    }, 300);

    const debouncedProductSearch = debounce(async (query) => {
        const resultsContainer = document.getElementById('productSearchResultsContainer');
        if (query.length < 1) {
            resultsContainer.style.display = 'none';
            return;
        }
        const { data, error } = await supabaseClient
            .from('products')
            .select('*')
            .or(`name.ilike.%${query}%,code.ilike.%${query}%`);

        resultsContainer.innerHTML = '';
        if (error || !data.length) {
            resultsContainer.style.display = 'none';
            return;
        }

        data.forEach(product => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.textContent = `${product.name} (${product.brand || 'N/A'})`;
            item.onclick = () => selectProduct(product);
            resultsContainer.appendChild(item);
        });
        resultsContainer.style.display = 'block';
    }, 300);

    function selectClient(client) {
        selectedClientForQuotation = client;
        clientNameInput.value = client.name;
        billingAddressInput.value = client.address || '';
        clientSearchInput.value = '';
        clientSearchResultsContainer.style.display = 'none';
    }

    function selectProduct(product) {
        selectedProductForAdding = product;
        productNameInput.value = product.name;
        brandInput.value = product.brand || '';
        unitSelect.value = product.uom || 'Nos';
        descriptionInput.value = product.description || '';
        priceInput.value = product.price || '';
        document.getElementById('taxRule').value = product.tax_rule || 'cgst_sgst';
        productSearchInput.value = '';
        productSearchResultsContainer.style.display = 'none';
        quantityInput.focus();
    }

    // --- EVENT HANDLERS & SETUP ---
    function setupEventListeners() {
        clientSearchInput.addEventListener('keyup', (e) => debouncedClientSearch(e.target.value));
        productSearchInput.addEventListener('keyup', (e) => debouncedProductSearch(e.target.value));
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                clientSearchResultsContainer.style.display = 'none';
                productSearchResultsContainer.style.display = 'none';
            }
        });
        addProductBtn.addEventListener('click', addProduct);
        savedProductsBody.addEventListener('click', handleTableClick);
        saveQuotationBtn.addEventListener('click', () => saveOrUpdateQuotation(true));
        generatePdfBtn.addEventListener('click', generateQuotationPDF);
        document.querySelector('.actions .back').addEventListener('click', () => {
        window.location.href = "dashboard.html";
        });
        document.querySelector('.actions .cancel').addEventListener('click', newQuotation);
    }

    function showConfirmation(text, callback) {
        modalText.textContent = text;
        confirmCallback = callback;
        confirmModal.style.display = 'flex';
    }
    modalConfirmBtn.onclick = () => { if (confirmCallback) confirmCallback(); confirmModal.style.display = 'none'; };
    modalCancelBtn.onclick = () => { confirmModal.style.display = 'none'; };

    // --- PRODUCT & QUOTATION LOGIC ---
    function clearProductInputs() {
        productNameInput.value = ""; brandInput.value = ""; descriptionInput.value = "";
        quantityInput.value = "1"; priceInput.value = ""; discountInput.value = "0";
        selectedProductForAdding = null;
        productSearchInput.value = "";
        productNameInput.focus();
    }

    function addProduct() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        if (!selectedProductForAdding || quantity <= 0 || price < 0) {
            alert("Please search and select a product, and enter a valid quantity and price."); return;
        }
        const productData = {
            productName: selectedProductForAdding.name, brand: brandInput.value.trim(), unit: unitSelect.value,
            description: descriptionInput.value.trim(), quantity: quantity,
            price: price, discountPercent: parseFloat(discountInput.value) || 0
        };
        productData.total = (productData.price * (1 - productData.discountPercent / 100)) * productData.quantity;

        if (currentlyEditingIndex !== null) {
            savedProducts[currentlyEditingIndex] = productData;
            currentlyEditingIndex = null;
            addProductBtn.textContent = "‚ûï Add Product";
        } else {
            savedProducts.push(productData);
        }
        renderTable(); updateTotals(); clearProductInputs();
    }
    
    function renderTable() {
        savedProductsBody.innerHTML = '';
        savedProductsTable.style.display = savedProducts.length > 0 ? "table" : "none";
        savedProducts.forEach((product, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${product.productName}${product.description ? `<br><small style="color:var(--gray)">${product.description}</small>` : ''}</td>
                <td>${product.brand || '-'}</td><td>${product.unit}</td>
                <td>${product.quantity}</td><td>${product.price.toFixed(2)}</td><td>${product.discountPercent.toFixed(2)}</td>
                <td>${product.total.toFixed(2)}</td>
                <td>
                    <button class="action-btn edit-btn" data-index="${index}">Edit</button>
                    <button class="action-btn remove-btn" data-index="${index}">Remove</button>
                </td>`;
            savedProductsBody.appendChild(tr);
        });
    }
    
    function handleTableClick(event) {
        const target = event.target;
        if (target.tagName !== 'BUTTON') return;
        const index = parseInt(target.dataset.index, 10);
        if (target.classList.contains('remove-btn')) {
            showConfirmation("Are you sure you want to remove this product?", () => {
                savedProducts.splice(index, 1); renderTable(); updateTotals();
            });
        } else if (target.classList.contains('edit-btn')) {
            editProduct(index);
        }
    }

    function editProduct(index) {
        currentlyEditingIndex = index;
        const product = savedProducts[index];
        productSearchInput.value = product.productName;
        productNameInput.value = product.productName; brandInput.value = product.brand;
        unitSelect.value = product.unit; descriptionInput.value = product.description;
        quantityInput.value = product.quantity; priceInput.value = product.price;
        discountInput.value = product.discountPercent;
        selectedProductForAdding = { name: product.productName };
        addProductBtn.textContent = "‚úî Update Product";
        document.getElementById('productInputRow').scrollIntoView({ behavior: 'smooth' });
    }

    function updateTotals() {
        const taxRule = document.getElementById("taxRule").value;
        let subtotal = savedProducts.reduce((sum, p) => {
            const discountedPrice = p.price * (1 - (p.discountPercent || 0) / 100);
            return sum + (discountedPrice * p.quantity);
        }, 0);
        let cgst = 0, sgst = 0, igst = 0;
        if (taxRule === "cgst_sgst") {
            cgst = subtotal * 0.09; sgst = subtotal * 0.09;
        } else {
            igst = subtotal * 0.18;
        }
        const totalTax = cgst + sgst + igst;
        const grandTotal = subtotal + totalTax;
        document.getElementById("subtotal").textContent = subtotal.toFixed(2);
        document.getElementById("cgst").textContent = cgst.toFixed(2);
        document.getElementById("sgst").textContent = sgst.toFixed(2);
        document.getElementById("igst").textContent = igst.toFixed(2);
        document.getElementById("totalTax").textContent = totalTax.toFixed(2);
        document.getElementById("grandTotal").textContent = grandTotal.toFixed(2);
        document.getElementById("cgstRow").style.display = taxRule === "cgst_sgst" ? "flex" : "none";
        document.getElementById("sgstRow").style.display = taxRule === "cgst_sgst" ? "flex" : "none";
        document.getElementById("igstRow").style.display = taxRule === "igst" ? "flex" : "none";
        document.getElementById("totalTaxRow").style.display = "flex";
    }
    
    function numberToWordsInr(num) {
        const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
        const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        function inWords(n) {
            let str = '';
            if (n > 99) { str += a[Math.floor(n / 100)] + 'hundred '; n %= 100; }
            if (n > 19) { str += b[Math.floor(n / 10)] + ' ' + a[n % 10]; } else { str += a[n]; }
            return str;
        }
        const numStr = parseFloat(num).toFixed(2);
        const [rupees, paise] = numStr.split('.');
        const rupeesInt = parseInt(rupees, 10);
        let words = rupeesInt > 0 ? (Math.floor(rupeesInt / 10000000) > 0 ? inWords(Math.floor(rupeesInt / 10000000)) + 'crore ' : '') + (Math.floor((rupeesInt % 10000000) / 100000) > 0 ? inWords(Math.floor((rupeesInt % 10000000) / 100000)) + 'lakh ' : '') + (Math.floor((rupeesInt % 100000) / 1000) > 0 ? inWords(Math.floor((rupeesInt % 100000) / 1000)) + 'thousand ' : '') + (rupeesInt % 1000 > 0 ? inWords(rupeesInt % 1000) : '') : 'zero ';
        let finalString = 'Rupees ' + words.replace(/\s+/g, ' ').trim().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        if (parseInt(paise, 10) > 0) { finalString += ' and ' + inWords(parseInt(paise, 10)).trim() + ' paise'; }
        return finalString.trim() + ' Only';
    }

    // --- SUPABASE & DATA HANDLING FUNCTIONS ---
    function getQuotationDataFromForm() {
        const clientName = clientNameInput.value.trim();
        if (!clientName || !document.getElementById("quotationDate").value || savedProducts.length === 0) {
            alert("Please select a Client, set a Quotation Date, and add at least one product."); return null;
        }
        return {
            id: quotationIdInput.value || undefined, company_name: document.getElementById("companySelect").value,
            client_name: clientName, 
            client_gstin: selectedClientForQuotation ? selectedClientForQuotation.gstin : null,
            branch_name: document.getElementById("branchName").value.trim(),
            customer_name: document.getElementById("customerName").value.trim(), reference_number: document.getElementById("referenceNumber").value.trim(),
            billing_address: billingAddressInput.value.trim(), quotation_date: document.getElementById("quotationDate").value,
            tax_rule: document.getElementById("taxRule").value, products: savedProducts,
            subtotal: parseFloat(document.getElementById("subtotal").textContent), cgst: parseFloat(document.getElementById("cgst").textContent),
            sgst: parseFloat(document.getElementById("sgst").textContent), igst: parseFloat(document.getElementById("igst").textContent),
            total_tax: parseFloat(document.getElementById("totalTax").textContent), grand_total: parseFloat(document.getElementById("grandTotal").textContent),
        };
    }

    let isSaving = false;

async function saveOrUpdateQuotation(showAlert = true) {
    if (isSaving) return null; // Prevent duplicate save
    isSaving = true;

    const quotationData = getQuotationDataFromForm();
    if (!quotationData) {
        isSaving = false;
        return null;
    }

    const { id, ...dataToSave } = quotationData;
    let result, error;

    if (id) {
        const { data, error: updateError } = await supabaseClient
            .from('quotations')
            .update(dataToSave)
            .eq('id', id)
            .select()
            .single();
        result = data;
        error = updateError;
    } else {
        const { data, error: insertError } = await supabaseClient
            .from('quotations')
            .insert([dataToSave])
            .select()
            .single();
        result = data;
        error = insertError;
    }

    isSaving = false;

    if (error) {
        console.error('Error saving quotation:', error);
        if (showAlert) alert(`Failed to save quotation: ${error.message}`);
        return null;
    }

    if (showAlert) {
        alert(id ? '‚úÖ Quotation updated successfully!' : '‚úÖ Quotation saved successfully!');
    }

    quotationIdInput.value = result.id;
    window.history.replaceState({}, '', `?id=${result.id}`);
    lastSavedQuotationData = { ...result, ...quotationData };

    return lastSavedQuotationData;
}
    async function loadQuotationForEdit(id) {
        const { data: q, error } = await supabaseClient.from('quotations').select('*').eq('id', id).single();
        if (error) {
            alert(`Failed to load quotation: ${error.message}`); newQuotation();
        } else {
            quotationIdInput.value = q.id; 
            clientNameInput.value = q.client_name || "";
            selectedClientForQuotation = { name: q.client_name, gstin: q.client_gstin };
            document.getElementById("companySelect").value = q.company_name || "Datamedia";
            document.getElementById("branchName").value = q.branch_name || "";
            document.getElementById("customerName").value = q.customer_name || "";
            document.getElementById("referenceNumber").value = q.reference_number || "";
            billingAddressInput.value = q.billing_address || "";
            document.getElementById("quotationDate").value = q.quotation_date || '';
            document.getElementById("taxRule").value = q.tax_rule || "cgst_sgst";
            savedProducts = q.products || [];
            renderTable(); updateTotals();
        }
    }

    function newQuotation() {
        showConfirmation("Are you sure you want to clear the form and start a new quotation?", () => {
            quotationForm.reset(); clientSearchInput.value = '';
            quotationIdInput.value = ""; document.getElementById("quotationDate").value = new Date().toISOString().slice(0, 10);
            savedProducts = []; currentlyEditingIndex = null; selectedClientForQuotation = null;
            renderTable(); updateTotals(); addProductBtn.textContent = "‚ûï Add Product";
            window.history.pushState({}, document.title, window.location.pathname);
        });
    }

    async function generateQuotationPDF() {
        const savedData = await saveOrUpdateQuotation(false); 
        if (!savedData) { alert("Could not save quotation data. Please check for errors."); return; }
        if (savedProducts.length === 0) { alert("Please add at least one product."); return; }
        
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setProperties({ title: `Quotation for ${savedData.client_name}`, subject: 'Sales Quotation' });
        
        // --- START: LOGO & SEAL PLACEHOLDERS ---
        // Instructions:
        // 1. Convert your logo and seal images to Base64 strings. You can use an online tool for this.
        // 2. Paste the full Base64 string (including "data:image/png;base64,...") into these variables.
        const logoBase64 = "YOUR_LOGO_BASE64_STRING"; // Replace with your logo Base64 string
        const sealBase64 =""
        const companyName = "Datamedia", companyAddress = "Souparnika Building, Varanadu, Cherthala, Kerala 32", companyPincode = "688524",
              companyPhone = "YOUR_PHONE_NUMBER", companyGstin = "YOUR_GSTIN", clientName = savedData.client_name,
              billingAddress = savedData.billing_address, quotationDate = new Date(savedData.quotation_date).toLocaleDateString('en-IN'),
              quotationNumber = `QUO-${savedData.id}`;
        
        const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
        const rightMargin = 196, leftMargin = 14;

        const addFullHeader = () => {
            doc.setFontSize(16).setFont('helvetica', 'bold').text("SALES QUOTATION", 105, 15, { align: "center" });
            
            if (logoBase64) {
                try { doc.addImage(logoBase64, 'PNG', rightMargin - 30, 5, 40, 25); }
                catch(e) { console.error("Error adding logo image:", e); }
            }

            let currentY = 40;
            doc.setFontSize(13).setFont('helvetica', 'bold').text(companyName, leftMargin, currentY);
            doc.setFont('helvetica', 'normal').setFontSize(10).text(doc.splitTextToSize(companyAddress, 80), leftMargin, currentY + 5);
            doc.text(`Pincode: ${companyPincode}`, leftMargin, currentY + 15).text(`Phone: ${companyPhone}`, leftMargin, currentY + 20).text(`GSTIN: ${companyGstin}`, leftMargin, currentY + 25);
            
            doc.setFontSize(10).setFont(undefined, 'bold');
            doc.text(`Quotation No: ${quotationNumber}`, leftMargin, currentY + 35);
            doc.text("Date: " + quotationDate, leftMargin, currentY + 40);

            let billToY = 40;
            doc.setFontSize(12).setFont('helvetica', 'bold').text("Bill To:", 140, billToY);
            billToY += 6;
            doc.setFontSize(10).setFont('helvetica', 'normal');
            const clientNameLines = doc.splitTextToSize(clientName, 56);
            doc.text(clientNameLines, 140, billToY);
            billToY += clientNameLines.length * 5;
            const addressLines = doc.splitTextToSize(billingAddress, 56);
            doc.text(addressLines, 140, billToY);
            billToY += addressLines.length * 5;
            doc.text(`GSTIN: ${savedData.client_gstin || 'N/A'}`, 140, billToY);
            
            return Math.max(currentY + 50, billToY + 10);
        };
        
        doc.autoTable({
            startY: addFullHeader(), head: [["Product / Description", "Brand", "Unit", "Qty", "Price", "Disc", "Total"]],
            body: savedProducts.map(p => [`${p.productName}${p.description ? `\n(Desc: ${p.description})` : ''}`, p.brand || '-', p.unit, p.quantity, p.price.toFixed(2), p.discountPercent > 0 ? `${p.discountPercent}%` : '-', p.total.toFixed(2)]),
            theme: 'grid', headStyles: { fillColor: [0, 173, 181], textColor: 255 },
            styles: { font: 'helvetica', fontSize: 9, cellPadding: 2, valign: 'middle' },
            didParseCell: (data) => { if (data.column.dataKey === 0) data.cell.styles.valign = 'top'; }
        });
        
        let finalY = doc.lastAutoTable.finalY;
        let totalsY = finalY + 10;
        const grandTotalInWords = numberToWordsInr(savedData.grand_total);
        doc.setFont('helvetica', 'bold').setFontSize(9).text("Amount in Words:", 130, totalsY, { align: 'left' });
        doc.setFont('helvetica', 'normal').text(doc.splitTextToSize(`(${grandTotalInWords})`, rightMargin - 130), 130, totalsY + 4);
        totalsY += doc.splitTextToSize(grandTotalInWords, rightMargin - 130).length * 4 + 5;

        const drawTotalsRow = (label, value, isBold = false) => {
            if (totalsY > pageHeight - 30) { doc.addPage(); totalsY = 20; }
            doc.setFont('helvetica', isBold ? 'bold' : 'normal').text(label, 130, totalsY, { align: 'left' }).text(`Rs ${value}`, rightMargin, totalsY, { align: 'right' });
            totalsY += 6;
        };
        
        drawTotalsRow("Subtotal:", savedData.subtotal.toFixed(2));
        if (savedData.tax_rule === 'cgst_sgst') {
            drawTotalsRow("CGST (9%):", savedData.cgst.toFixed(2));
            drawTotalsRow("SGST (9%):", savedData.sgst.toFixed(2));
        } else {
            drawTotalsRow("IGST (18%):", savedData.igst.toFixed(2));
        }
        drawTotalsRow("Total Tax:", savedData.total_tax.toFixed(2));
        totalsY += 1;
        drawTotalsRow("Grand Total:", savedData.grand_total.toFixed(2), true);
        
        let footerY = pageHeight - 90;
        if (doc.lastAutoTable.finalY > footerY - 20) {
            doc.addPage();
        }
        
        doc.setFontSize(10).setFont("helvetica", 'bold').text("Terms & Conditions:", leftMargin, footerY);
        footerY += 5;
        doc.setFontSize(8).setFont("helvetica", 'normal');
        const terms = [
            "1. Taxes: Inclusive of all Taxes (GST 18%)",
            "2. Warranty - Warranty period is from one year from the date of purchase against manufacturing defects. it shall be limited to repair. No warranty for Adaptor/Power supply and no warranty for burnouts.",
            "3. Delivery - Within 15 Days from the date of receipt of technically and commercially cleared purchase order.",
            "4. Purchase order- For material supply should be in favour of M/s Datamedia.",
            "5. Validity of quotation - 30 Days",
            "6. Payment - 100% payment upon completion.",
            "7. Payment- to be made by Cash/DD/Cheque in favour of M/s Datamedia.",
            "8. Billing- As per actual",
            "9. Additional work if charges extra"
        ];
        terms.forEach(term => { 
            const lines = doc.splitTextToSize(term, 180);
            doc.text(lines, leftMargin, footerY);
            footerY += (lines.length * 3.5);
        });
        
        const signatureBlockY = pageHeight - 40; 
        if (sealBase64) {
            try { doc.addImage(sealBase64, 'PNG', rightMargin - 28, signatureBlockY - 34, 30, 30); }
            catch (e) { console.error("Error adding seal image:", e); }
        }

        doc.setFontSize(10).text(`For ${companyName}`, rightMargin, signatureBlockY, { align: 'right' });
        doc.text(`Authorised Signatory`, rightMargin, signatureBlockY + 5, { align: 'right' });
        
        for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
            doc.setPage(i);
            doc.setLineWidth(0.1).line(leftMargin, pageHeight - 15, rightMargin, pageHeight - 15);
            doc.setFontSize(8).text("This is a computer-generated quotation.", 105, pageHeight - 10, { align: 'center' }).text(`Page ${i} of ${doc.internal.getNumberOfPages()}`, rightMargin, pageHeight - 10, { align: 'right' });
        }
        doc.save(`Quotation_${clientName.replace(/ /g, '_')}_${quotationNumber}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
